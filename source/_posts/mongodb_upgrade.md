title: Mongodb升级总结
author: James
tags:

  - mongodb
categories:
  - 数据库
date: 2018-12-24 11:41:00

---

# 起因

最近接手大后端后，开始整理之前的遗留问题，其中mongodb还停留在很早之前的版本。线上的部署和监控也及其混乱，所以决定和运维一起升级到mongodb到新版本。

虽然官网的介绍，新版本用了新WT引擎，吞吐量提升10倍芸芸；但是只有经过自己的实践和测试才能确认。

<!-- more -->

## **测试目标**
**1.数据库V2.6 和 V 4.0版本对比测试**
**2.结合业务数据性能对比测试**

**测试计划**

-  性能对比测试。   目的：通过测试数据确认升级版本有没有提升， 到底提升了多少。
-  核心业务压力对比测试。 目的：通过测试验证升级版本对业务相关数据的性能提升了多少。 
-  业务代码驱动升级，为未来重构升级。原因：老业务驱动升级导致方法变得太大。
-  测试服切换到4.0 进行全面业务测试 。
-  正式服数据硬件升级。
-  正式服数据库配置准备。  
-  正式服停机切换正式服。

**压力测试服务器配置信息：**

| 业务          | IP             | 系统环境  | CPU                                             | 内存 | 硬盘SSD | raid   |
| ------------- | -------------- | --------- | ----------------------------------------------- | ---- | ------- | ------ |
| mongo         | 192.168.31.237 | CentOS7.2 | Intel(R) Xeon(R) CPU E5-2678 v3 @ 2.50GHz 24核  | 16G  | 1T      | raid10 |
|               | 192.168.31.164 | CentOS7.2 | Intel(R) Xeon(R) Silver 4114 CPU @ 2.20GHz 40核 | 16G  | 250G    | 无     |
| 测试机YCSB    | 192.168.31.80  | CentOS7.2 | Intel(R) Xeon(R) Silver 4114 CPU @ 2.20GHz 4核  | 4G   | 50G     | 无     |
| 监控mongo-mms | 192.168.31.82  | CentOS7.2 | Intel(R) Xeon(R) Silver 4114 CPU @ 2.20GHz 4核  | 4G   | 50G     | 无     |


**测试准备:**
1. **监控**：在测试之前需要配置好监控，包含各种数据库性能指标以及机器资源使用率的监控。
2. **测试场景的设计**：在单独的数据库性能测试中，必须包含的几个场景有： 只读，读写混合，只写，这3个场景分别包含下面2个场景
3. **数据库的初始化**： 在测试之前需要准备测试数据，包含业务的测试需要制作业务的测试数据，纯数据库相关的测试可以自己生成测试数据。
4. **预热**：在测试之前需要将部分数据加载到内存中，如果没有预热，在测试的时候加载数据，这种情况与线上的情况不同，对测试结果又影响。
5. **测试结果的分析**，对于测试结果的分析一般要包含机器资源使用的分析，数据库监控指标的分析，慢sql的分析，数据库错误日志的查看。
   同时结合压测工具或自己配置的工具生成的结果去分析，是否有慢sql,是否有资源使用波动，结果的tps，qps是否满足预期等。在做性能测试的时候，
   目的是测试数据库的表现，不是测试数据库究竟能承受多大的压力，所以我们的测试机器配置一定要足够，不要出现因为机器资源导致的限制。
6. **调整，优化：**但是最好每次调整一个方面的配置，调整后再次测试，记录结果并对比查看效果。涉及业务的测试在分析的时候需要配合研发同学分析定位问题。


**系统:**
1. 文件系统 ：XFS
2. ulimit - 623000

**mongoDB conf配置**

| mongoDB | conf 核心配置       | 测试IP和端口         |
| ------- | ------------------- | -------------------- |
| V2.6    | mmpv                | 192.168.31.237:10000 |
|         |                     | 192.168.31.164:10000 |
|         |                     | 192.168.31.237:10000 |
| V4.0.4  | wt: snappy 压缩算法 | 192.168.31.164:10000 |

**驱动升级：**

1. java 应用、ttop-rest 框架升级
2. groovy 脚本
3. node js

## **第一阶段压力测试结果：**

**编码业务脚本**

| 用例                                                         | V2.6                          | v4.0                          |
| ------------------------------------------------------------ | ----------------------------- | ----------------------------- |
| `update: 100用户 1000000 次 1个实例`                         | `tps: 1700 `                  | `tps: 5万 `                   |
| `update: ``100用户 1000000 次 2个实例`                       | `tps: 1800`                   | `tps: 4.7万`                  |
| `update: ``100用户 10000 次 3个实例`                         | `tps: 1700`                   | `tps: 4.7万`                  |
| `update: ``200用户 500 次 3个实例`                           | `tps: 1700`                   |                               |
| `update: ``300用户 200 次 3个实例`                           | `tps: 1700 `                  |                               |
| `update: ``300用户 200 次 5个实例`                           | `tps: 1700`                   |                               |
| `query:``300 用户 10000次 3个实例`                           | `tps: 4万`                    | `tps: 4.3万 query`            |
| query and update:`100 用户 update 10000次 2个实例500 用户 10000次 3个实例` | `tps: 600 update 2.7万 query` | `tps: 4万 update 1.8万 query` |
|                                                              |                               |                               |

**YCSB 测试脚本**

| 版本                                  | 线程数 | 数据量   | 吞吐量 | 总耗时  | 操作类型     | 操作数     | 平均延迟            | 95线   | 99线          |               |               |
| ------------------------------------- | ------ | -------- | ------ | ------- | ------------ | ---------- | ------------------- | ------ | ------------- | ------------- | ------------- |
| 2.6                                   | 100    | 1kw      | 2000   | 500509  | UPDATE 100%  | 1000000    | 1987.95             | 1275   | 10407         |               |               |
| 4.03                                  | 100    | 1kw      | 2000   | 500484  | UPDATE 100%  | 1000000    | 1550.75             | 2014   | 18655         |               |               |
|                                       |        |          |        |         |              |            |                     |        |               |               |               |
| 2.6                                   | 50     | 1kw      | 10000  | 1065629 | UPDATE 100%  | 1000000    | 5302.35             | 11159  | 18847         |               |               |
| 4.03                                  | 50     | 1kw      | 10000  | 1000406 | UPDATE 100%  | 1000000    | 513                 | 808    | 1773          |               |               |
|                                       |        |          |        |         |              |            |                     |        |               |               |               |
| 版本                                  | 内存   | 压缩算法 | 线程数 | 数据量  | 吞吐量       | 总耗时     | 操作类型            | 操作数 | 平均延迟      | 95线          | 99线          |
| 4.03                                  | 8G     | snappy   | 100    | 1800w   | 2w           | 750431     | UPDATE 100%         | 1500w  | 1131.28       | 3205          | 12815         |
| 4.03                                  | 16G    | snappy   | 100    | 1800w   | 2w           | 750447     | UPDATE 100%         | 1500w  | 535.27        | 999           | 3323          |
| 4.03                                  | 8G     | snappy   | 100    | 1800w   | 4w           | 375460     | UPDATE 100%         | 1500w  | 1159.33       | 3415          | 11727         |
| 4.03                                  | 16G    | snappy   | 100    | 1800w   | 4w:35526.92  | 422215     | UPDATE 100%         | 1500w  | 2727          | 10615         | 21679         |
| 4.03                                  | 8G     | snappy   | 100    | 1800w   | 8w           | 342548     | UPDATE 100%         | 1500w  | 2264.12       | 5731          | 14103         |
| 4.03                                  | 16G    | snappy   | 100    | 1800w   | 8w:39402.76  | 380684     | UPDATE 100%         | 1500w  | 2518          | 8103          | 18591         |
| 4.03                                  | 16G    | snappy   | 100    | 1800w   | 3w:29971     | 500476     | UPDATE 100%         | 1500w  | 594.73        | 1562          | 5431          |
| 4.03                                  | 16G    | snappy   | 50     | 1800w   | 1w:9830.52   | 1017240    | READ 80% UPDATE 20% | 1500w  | R:411 U:1417  | R:679 U:2127  | R:1440 U:4691 |
| 4.03                                  | 16G    | snappy   | 50     | 1800w   | 10w:20485.25 | 2440780    | UPDATE 100%         | 1500w  | 2424          | 4899          | 7919          |
| 4.03                                  | 16G    | snappy   | 50     | 1800w   | 3000:2972.78 | 336385     | UPDATE 100%         | 1500w  | 1210.77       | 1754          | 2343          |
|                                       |        |          |        |         |              |            |                     |        |               |               |               |
| 版本                                  | 内存   | 压缩算法 | 线程数 | 数据量  | 吞吐量       | 总耗时(ms) | 操作类型            | 操作数 | 平均延迟      | 95线          | 99线          |
| 4.03                                  | 16G    | snappy   | 50     | 1800w   | 1w:9830.52   | 1017240    | READ 80% UPDATE 20% | 1500w  | R:411 U:1417  | R:679 U:2127  | R:1440 U:4691 |
| 4.03                                  | 16G    | snappy   | 50     | 1800w   | 10w:50479.45 | 990502     | READ 50% UPDATE 50% | 5000w  | R:411 U:1417  | R:679 U:2127  | R:1440 U:4691 |
| room_cost: 2000字节                   |        |          |        |         |              |            |                     |        |               |               |               |
| 4.03                                  | 16G    | snappy   | 100    | 5000w   | 10w:53683.14 | 931391     | READ 70% UPDATE 30% | 5000w  | R:1835 U:1767 | R:3893 U:3719 | R:7487 U:7303 |
| 4.03                                  | 16G    | snappy   | 50     | 5000w   | 1w:9988      | 500585     | READ 70% UPDATE 30% | 5000w  | R:381 U:1420  | R:630 U:2167  | R:1628 U:5015 |
| 4.03                                  | 16G    | snappy   | 50     | 5000w   | 1w:9830      | 1017240    | READ 80% UPDATE 20% | 1000w  | R:411 U:1417  | R:679 U:2127  | R:1440 U:4691 |
| 4.03                                  | 16G    | snappy   | 50     | 5000w   | 10w:20485    | 2440780    | UPDATE 100%         | 5000w  | 2423          | 4899          | 7919          |
| 4.03                                  | 16G    | snappy   | 500    | 5000w   | 10w:22120    | 2260346    | UPDATE 100%         | 5000w  | 22589         | 28831         | 36159         |
|                                       |        |          |        |         |              |            |                     |        |               |               |               |
| room_cost: 2000字节 稠密索引 二段提交 |        |          |        |         |              |            |                     |        |               |               |               |
| 2.6                                   | 16G    |          | 50     | 5000w   | 1w:1250      | 7968475    | UPDATE 100%         | 1000w  | 40000         | 58240         | 75000         |
| 2.6                                   | 16G    |          | 50     | 5000w   | 1w:1200      | 827583     | UPDATE 100%         | 100w   | 41276         | 59390         | 77824         |
|                                       |        |          |        |         |              |            |                     |        |               |               |               |
| room_cost: 2000字节 稀疏索引 二段提交 |        |          |        |         |              |            |                     |        |               |               |               |
| 2.6                                   | 16G    |          | 50     | 5000w   | 1w:1250      | 794075     | UPDATE 100%         | 100w   | 39407         | 57311         | 75775         |

# 总结:
1. v4.0版本的update吞吐量大幅提升(10倍)优于v2.6。 由于引擎的更换。
2. v4.0版本的query优化幅度极小，可以忽略不计。
3. query and update v4.0版本的吞吐量大幅提升(10倍）。
4. 内存足够大的情况下，CPU是瓶颈，CPU表现越好的机器，性能越好。

[**其他人压测结果参考**](http://www.mongoing.com/benchmark_3_0)

[**官方压测对比报告**](http://www.mongoing.com/archives/862)
