title: 从面试谈到数据库索引
author: James
tags:
  - 索引
  - 数据库
categories:
  - 数据库
date: 2019-11-15 10:15:00

---

# 前言

最近招聘后端工程师，我们会考察一些数据库相关的题目，特别是关于索引用法以及索引的原理， 相信在各大互联网公司面试中大家也会常常遇到的此类题目。发现能回答好的人不是特别多； 然而作为一名后端工程师，经常需要跟数据库打交道的，即便是最基础的CRUD操作，如果只是会用还不够，当线上真实场景数据量上来后，如果没有深入理解很容发生严重的问题。故而整理此篇博客坐下来好好聊数据库索引。

<!-- more -->
**本文的重点:**

1. 几种常见的索引 
2. 索引的原理
3. 实战中的应用

#  **数据库为什么要设计索引？** 
可以想象下：一个图书馆中存了几千万本图书，借书人要从中找到《数据库原理》，如果需要一本本查，要查到什么时候去？于是，图书管理设计了一套检索规则：
(1)一楼放历史类，二楼放文学类，三楼放IT类…
(2)IT类，又分软件类，硬件类…
(3)软件类，又按照书名音序排序…以便快速找到一本书。
与之类比，数据库存储了几千万条数据，要从中找到name=”database”的记录，如果一条条遍历，需要查到什么时候去？于是，有了**索引**，用于提升数据库的查找速度。

# 常见索引模型
1. 哈希索引
2. B+树索引
3. 全文索引（本文暂不做讨论）

## 哈希索引
哈希索引是以键值对（key-value）存储结构，只要根据 key 就可以找到 value。可以理解为一个数组，对 key 进行哈希计算，换算成一个确定的位置，把 value 放入此位置。因为存储hash冲突的情况，多个value可能在同一个位置上，使用链表，后来的就追加到链表中。如图
![hash](/images/indexs/hash.png)

## B+树索引

### 二叉树查找树
聊B+树之前我们先聊聊其他的二叉树， 也能够更清楚为什么数据库要选择B+树的结构。

 **二叉树查找树是一种经典的数据结构，要求左子树小于根节点，右子树大于根节点。** 
**特点:** 左子节点 < 父节点，父节点 < 右子节点。 
如有 3、1、2、10、9、0、4、6 这8个数据 如果顺序查找，则需要查找8次（位于最后）。
二叉树查找树查找：先找到根4，4<6，因此查找4的右子树，找到9；9大于6，因此查找9的左子树；一共只需要查找3次。
如下图所示:
![hash](/images/indexs/sreachTree.png)
 缺点：按照二叉查找树的定义，它是可以任意的构造，所以同样的数据。同样查找数据6，需要查找5次。 
![hash](/images/indexs/st2.png)

### 平衡二叉树（AVL树）
 因此为了最大性能地构造一个二叉查找树，需要它是平衡的，即平衡二叉树。 
 **平衡二叉树定义：首先符合二叉查找树的定义，另外任何节点的两个子树高度最大差为1。** 
平衡二叉树的查询速度是很快的，但是有缺点：

1. 维护树的代价是非常大，在进行插入或更新时，经常会需要多次左旋或右旋来维持平衡。
2. 数据量多的时候，树会很高，需要多次I/O操作。
![hash](/images/indexs/avl.png)

### B+ 树
1.非叶子节点不再存储数据，数据只存储在同一层的叶子节点上， 且是**顺序存放** 。
2.B+树中根到每一个节点的路径长度一样。
3.叶子之间，增加了链表，获取所有节点。

![hash](/images/indexs/B+tree.png)

优点：
1. B+树的高度一般为2-4层，所以查找记录时最多只需要2-4次**磁盘IO**，相对二叉平衡树已经大大降低了。
2. 范围查找时，能通过叶子节点的指针获取数据。例如查找大于等于3的数据，当在叶子节点中查到3时，通过3的尾指针便能获取所有数据，而不需要再像二叉树一样再获取到3的父节点。

#### 为什么要减少磁盘IO次数
众所周知，数据实际是存储在磁盘中的，而磁盘IO的查找速度是要远小于内存速度的，所以减少磁盘IO的次数能很大程度的提高性能。
**局部性原理？**
其原理的逻辑是这样的：
(1)内存读写块，磁盘读写慢，而且慢很多；
(2)**磁盘预读**：磁盘读写并不是按需读取，而是按页预读，一次会读一页的数据，每次加载更多的数据，如果未来要读取的数据就在这一页中，可以避免未来的磁盘IO，提高效率。*通常，一页数据是4K。*
(3)**局部性原理**：软件设计要尽量遵循“数据读取集中”与“使用到一个数据，大概率会使用其附近的数据”，这样磁盘预读能充分提高磁盘IO；

### MySQL索引
#### 聚集索引（Clustered index ）
- 叶子节点存放了整张表的所有行数据。
- 非叶子节点并不存储行数据，是为了能存储更多索引键，从而降低B+树的高度，进而减少IO次数。
- 聚集索引的存储在物理上并不是连续的，每个数据页在不同的磁盘块，通过一个双向链表来进行连接。


#### 非聚集索引（Secondary indexes）
非聚集索引又叫辅助索引，叶子节点并不包含行记录数据，而是存储了聚集索引键。 
- 每个表可以有多个辅助索引
- 通过辅助索引查数据时，先查找辅助索引获得聚集索引的主键，然后通过主键索引来查找完整的行记录。
- 通过非主键索引比主键索引查找速度要慢一倍

# 总结
- 数据库索引用于加速查询
- 虽然哈希索引是O(1)，树索引是O(log(n))，但SQL有很多“有序”需求，故数据库使用树型索引
- MySQL InnoDB不支持哈希索引
- **数据预读**的思路是：磁盘读写并不是按需读取，而是按页预读，一次会读一页的数据，每次加载更多的数据，以便未来减少磁盘IO
- **局部性原理**：软件设计要尽量遵循“数据读取集中”与“使用到一个数据，大概率会使用其附近的数据”，这样磁盘预读能充分提高磁盘IO
- 数据库的索引最常用B+树：
  - 很适合磁盘存储，能够充分利用局部性原理，磁盘预读；
  - 很低的树高度，能够存储大量数据；
  - (索引本身占用的内存很小；
  - 能够很好的支持单点查询，范围查询，有序性查询；