title: 研发团队之故障定级
author: James
tags:
  - 故障
  - 团队
categories:
  - 管理
date: 2019-09-26 11:38:00

---

# 前言

最近线上发生了一次严重事故，安卓客户端崩溃率从千分之二突然暴涨至百分之二，上涨了2000%。虽没有造成直接的经济损失，可是对用户体验伤害很大。 故而对此进行了一次细致的复盘；通过此次事件也发现了整个研发团队其实一直缺乏故障的处理规范和流程， 本文主要是整理流程规范以及模板。

<!-- more -->

# 事前预防
1. 规范代码规范、数据库设计规范、日志和告警打点规范
2. 规范git分支建立和合并、规范测试流程【全面的单元测试、测试介入】
3. 规范Review制度，明确审核的责任【识别出代码上线带来的风险，明确Review的仔细程度，P1以上故障Review人要负10%的责任】
4. 规范上线流程【每个项目都需要上线计划，包括配置、数据库、代码项目和发布顺序、回滚方案等】
5. 灰度发布、预发和监控机制，灰度应用出现问题及时回滚
6. 规范【数据清洗】等高风险行为，高度重视这类操作【容易被忽视】，必须提供完整方案【包括是否备份、如何回滚等】

------
# 事中处理

## 线上故障处理SOP
1. 线上故障第一要务【发布回滚】，因此针对高风险代码，一定要单独发布，便于回滚
2. 线上故障第二要务【周知干系人】，随时通报故障处理进度，让真正了解该问题的干系人尽早参与进来
3. 测试第一时间重现和记录BUG【JIRA】
4. 故障代码revert【通常来说，代码问题只要无法在30分钟内修复，就一定要回退代码，避免其他项目把错误代码带上线，再次带来故障】
5. 修复问题，完成回归测试后重新上线，如果BUG带来错误数据则需要全面评估数据清洗的风险，避免造成更加严重的次生伤害
6. 完成上线后，测试人员要验证线上BUG是否解决【上线后如还未解决，测试负责80%责任】

------

# 事后总结

## 故障定级
严重性逐步递增：P1~P4
一针对不同业务、不同层次、不同持续时间、不同后果细化故障定级，并且要周知所有干系人，确认后执行。

| **级别定义** | **描述值** | **具体定义**                                                 | **备注**                                                     |
| ---- | --- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 致命| P1         | 系统崩溃, 导致程序重启,死机或非法退出 。 数据丢失或异常  。产品核心流程无法正常使用(登录注册、首页浏览、主播间聊天和视频、送礼、小游戏、充值)。直接或间接造成经济损失30万以上。 | 不能完全满足系统要求，系统停止运行，系统的重要部件无法运行，系统崩溃或者挂起等导致系统不能正常运行, 直接或间接造成经济。 |
| 严重| P2         | 功能不符合用户需求  数据计算错误  业务流程错误  程序接口错误 因错误操作迫使程序中断； 系统可被执行，但操作功能无法执行（含指令）； 功能项的某些项目（选项）使用无效（对系统非致命的）； 功能实现不完整； 功能的实现不正确，如在系统实现的界面上，一些可接受输入的控件点击后无作用，对数据库的操作不能正确实现。直接或间接造成经济损失30万以下 | 严重地影响系统要求或基本功能的实现，且没有更正办法（重新安装或重新启动该软件不属于更正办法）。使系统不稳定、或破坏数据、或产生错误结果，或部分功能无法执行，而且是常规操作中经常发生或非常规操作中不可避免的主要问题，系统无法满足主要的业务要求，性能、功能或可用性严重降低。 |
| 一般| P3         | 数据长度不一致内容或格式错误  响应时间较慢  功能性建议 提示信息不太准确 操作界面错误（包括数据窗口内列名定义、含义是否一致）； 简单的输入限制未放在前台进行控制； 虽然正确性不受影响，但系统性能和响应时间受到影响； 不能定位焦点或定位有误，影响功能实现； | 系统可以满足业务要求，系统性能或响应时间变慢、产生错误的中间结果但不影响最终结果等影响有限的问题。 |
| 低级/建议| P4         | 界面不规范； 辅助说明描述不清楚； 输入输出不规范； 长时间操作未给用户提示； 提示窗口文字未采用行业术语； 可输入区域和只读区域没有明显的区分标志； 必填项与非必填项应加以区别； 滚动条无效； 键盘支持不好，如在可输入多行的字段中，不支持回车换行； 界面不能及时刷新，影响功能实现。 | 使用不方便或操作麻烦，但它不影响执行工作功能或重要功能。界面拼写错误或用户使用不方便等小问题或需要完善的问题. |


## 高压线
高压线要坚决杜绝，碰一次就要让责任人疼一次。
1. 未经测试和发布系统，私自变更线上代码和配置
2. 未经授权，私自在业务高峰期进行硬件和网络设备变更
3. 未知授权，私自在生产环境进行测试性质的操作
4. 未经授权，私自变更生产环境数据信息
5. 未经授权，私自导出公司内部数据

## 责任人范围
**【**开发人员**】**及其多级Leader、【测试人员】及其多级Leader**共同分摊**。
1. 由产品/运营设计不合理带来的bug，产品/运营同学需要负主要责任。
2. 有测试参与的任务，测试和研发共担责任  测试：研发 责任占比为6：4。
3. 代码问题 Review人要负10%的责任
4. 其他情况，研发负主要责任。

## 故障复盘
在故障处理完成后，一定要复盘并由责任人编写Case Study并根据相关价值决定是否需要团队内分享【一定要避免同样的问题再次发生】

------

### Case Study
**2019-09-11 XX bug事故报告**
**级别**：Px 作者：XX
**（一）事故影响**
 **摘要：9月11日凌晨崩溃率上升1.58%，陡增2000%；9月11日热修复后问题未到得解决崩溃率未降低**
影响范围 ：每日涉及1000个用户
时间：2019/09/11 17:24 ~ 2019/09/12 19:00
损失 : 无
责任方: 测试、研发部、产品
责任人: XXX XXX 

**（二）事故原因**
诱因 ：中秋活动中频繁进出直播间导致崩溃
主因 ：
1.在研发和测试过程中没有落实到每一个细节，活动特殊情况需要在特定时间段触发逻辑，没有及时在测试过程反馈。
2.研发自测未考虑完善 。
3.当天热修复发布后，未及时验证问题是否解决。

**（三）事故过程**
时间线 ：
2019/09/11 00:40 收到bugly预警，**崩溃率超过预警阈值。**
2019/09/11 10:00 研发同学定位的导致崩溃的原因
2019/09/11 11:00 研发修复问题
前期：安卓冒烟测试和核心模块回归测试缺失
发现、止损、解决、验证、恢复：发现问题到确认问题用了12个小时，二次修复未得到验证就发布
解决&自测&测试： 崩溃一直持续到9/11下午2点半，第二天9/12热更新补丁 修复 版本

**（四）问题总结和优化点及计划 **

| 事项                                                         | 责任人 | 完成时间           | 关联(JIRA/TB任务) |
| :----------------------------------------------------------- | :----- | :----------------- | :---------------- |
| 崩溃类型总结文档                                             | XXXXXX | 2019年10月30日     |                   |
| 每个迭代codereview                                           | XXXXXX | 每次GIT MR         |                   |
| bugly测试环境支持                                            | XXXXXX | 2019年9月15日      |                   |
| 每个迭代特殊功能测试点梳理组织                               | XXXXXX | 每个迭代需求会议后 |                   |
| 测试加强机型覆盖和意外操作测试                               | XXXXXX | 2019年9月30日      |                   |
| 制定故障处理流程，修复流程文档                               | XXXXXX | 2019年9月30日      |                   |
| 新的事故总结模板、故障评级、责任制度整理                     | XXXXXX | 2019年9月30日      |                   |
**（五）六问**
Q：设计、编码层面，有哪些问题？
A： 
Q：测试为什么没有发现？ 
A : 
Q：监控是否第一时间发现，为什么没有？
A： 
Q：为什么系统不能容错？ 
A: 
Q：解决速度能否更快、损失能否更小，如何做到？ 
A： 
Q：怎样避免类似情况发生？ 
A：



## 故障处罚
**基本原则：责任划分是次要，重点在预防**

1. **P1级别事故/高压线**： 公开邮件通报批评。相关人员以及多级leader绩效记为2分，直接影响年终奖金以及调薪。
2. **P2级别事故**： 公开邮件通报批评。故障复盘会议上，明确指出责任人，提出批评。
3. **P3级别事故**： 故障复盘会议上，明确指出责任人，提出批评。
4. **P4级别事故**： 内部迭代复盘会议指出问题，提出整改和方案

# 最后想说的

对于大公司大型团队合理的流程和制定能保证质量，而对于一个小团队而言，较为繁琐的流程和规范是一把双刃剑，很大可能会影响团队的效率和积极性。当责任与处罚挂钩，如果处置得不严谨和巧妙的话，最后必定会导致复盘会议变成一场甩锅的口舌之争，谁也不愿意背锅；多做多错，少做少错的思想可能也会在团队中蔓延。 所以如何用好这些制度和流程，如何在*减少公司损失*和*降低员工积极性* 两方面平衡好，要结合实际的情况慎重考虑。